# 第一个三角形

## 一、准备工作

在学习OpenGL时，我们需要干预cocos2d-x的渲染流程，让一切变得“自定义”。

### 自定义Director

**自定义Director是为了理解cocos设计的渲染流程，我们将在XX节，切换回默认的Dirctor**  

在设计中，cocos2d-x的初衷是Director是独立的且唯一的，但是核心渲染流程就在这里面，所以我们不得不让它变得可重写。

首先，添加方法  

```c++
Director* Director::setInstance(Director* ins)
{
    if (s_SharedDirector) {
        delete s_SharedDirector;
        s_SharedDirector = nullptr;
    }

    s_SharedDirector = ins;
    return s_SharedDirector;
}
```

然后将想重写的方法设置为virtual，目前只用到了drawScene  

```c++
virtual void drawScene();
```

自定义Director  

```c++
class DirectorCustom : public cocos2d::Director {
public:
    static DirectorCustom* create();
    virtual void drawScene() override;
};
```

设置自定义的Director，在`AppDelegate::applicationDidFinishLaunching`中替换  

```c++
// auto director = Director::getInstance(); 替换成下面的
auto director = Director::setInstance(DirectorCustom::create());
```

此刻，运行程序，应该看到了一个什么都没有的窗口。

OK，准备工作完成了

## 二、画三角形

`画三角形`是Openl中的`HelloWorld`，效果图是这样

![firstTriangle](firstTriangle.png)

### 纯OpenGL API实现

用纯OpenGL需要写一段简单的Shader。先不理解它的意思。写就完了。

定义shader：

```c++
// VertexShader 顶点着色器
const char * vert = R"(
    attribute vec4 a_position;
    attribute vec4 a_color;
    varying vec4 v_fragmentColor;

    void main()
    {
        gl_Position = a_position;
        v_fragmentColor = a_color;
    }
)";

// FragmentShader 片元着色器
const char * frag = R"(
    varying vec4 v_fragmentColor;

    void main()
    {
        gl_FragColor = v_fragmentColor;
    }
)";
```

然后，你需要创建一个GL程序，并初始化shader：

```c++
// 初始化顶点着色器
GLuint vertexShader = glCreateShader(GL_VERTEX_SHADER);
glShaderSource(vertexShader, 1, &vert, NULL);
glCompileShader(vertexShader);

// 初始化片元着色器
GLuint fragShader = glCreateShader(GL_FRAGMENT_SHADER);
glShaderSource(fragShader, 1, &frag, NULL);
glCompileShader(fragShader);

// GL link
GLuint glProgram = glCreateProgram();
glAttachShader(glProgram, vertexShader);
glAttachShader(glProgram, fragShader);
glLinkProgram(glProgram);
    
```

现在就可以画三角形了

```c++
// 设置顶点坐标和颜色
float vertices[] = {
    -1, -1,
    1, -1,
    0, 1,
};
float colors[] = {
    1, 0, 0, 1,
    0, 1, 0, 1,
    0, 0, 1, 1,
};

glEnableVertexAttribArray(0);
glEnableVertexAttribArray(1);
glVertexAttribPointer(0, 2, GL_FLOAT, GL_FALSE, 0, vertices);
glVertexAttribPointer(1, 4, GL_FLOAT, GL_FALSE, 0, colors);

// GL use
glUseProgram(glPrgram);
// 绘制三角形
glDrawArrays(GL_TRIANGLES, 0, 3);
```



完整代码：`Example/Demo1.cpp`



### Cocos2d-x API实现

cocos内置初始化了一些常用的Shader。

```c++
// 从Shader缓存中获取
auto glProgram = GLProgramCache::getInstance()->getGLProgram(GLProgram::SHADER_NAME_POSITION_COLOR);
// 这里使用的坐标系使用cocos的坐标系，原因内置的shader会将OpenGL坐标系转换为屏幕坐标系
auto size = Director::getInstance()->getVisibleSize();
float vertices[] = {
    0, 0,
    size.width/2, size.height,
    size.width, 0,
};
float colors[] = {
    1, 0, 0, 1,
    0, 1, 0, 1,
    0, 0, 1, 1,
};

GL::enableVertexAttribs(GL::VERTEX_ATTRIB_FLAG_POSITION | GL::VERTEX_ATTRIB_FLAG_COLOR);
glVertexAttribPointer(GLProgram::VERTEX_ATTRIB_POSITION, 2, GL_FLOAT, GL_FALSE, 0, vertices);
glVertexAttribPointer(GLProgram::VERTEX_ATTRIB_COLOR, 4, GL_FLOAT, GL_FALSE, 0, colors);

_glPrgram->use();
// 这个方法会初始化内置变量值，缓存中的shader使用的就是这些值
_glPrgram->setUniformsForBuiltins();

glDrawArrays(GL_TRIANGLES, 0, 3);

```

完整代码：`Example/Demo2.cpp`

